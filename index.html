<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
	<title>Sunrise Demo</title>
	<style>
		html,
		body {
			width: 100%;
			height: 100%;
			margin: 0;
			padding: 0;
			overflow: hidden;
		}
	</style>
</head>
<body>
	&nbsp;&nbsp;Start Time (second) <input type="text" id="start_time" style="width:50px;"/>
	&nbsp;&nbsp;Total Time (in seconds) <input type="text" id="total_time" style="width:50px;"/>
	&nbsp;&nbsp;Sun rise (second) <input type="text" id="sun_rise" style="width:50px;"/>
	&nbsp;&nbsp;Sun set (second) <input type="text" id="sun_set" style="width:50px;"/>
	<button onclick="sand_box_time()">Simulate</button><button onclick="live_time()">Show live</button>
	<br>
	<svg id="mysvg" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" width="600" height="600" viewBox="0 0 600 600">
		<style>
			#background {
				filter: url(#blurlayer);
				fill: url(#bgday);
			}

			.st2 {
				fill: none;
				stroke: rgba(0,0,0,0.3);
				stroke-width: 2px;
			}

			.st4 {
				fill: none;
				stroke: rgba(0,0,0,0.3);
				stroke-width: 4px;
			}
		</style>

		<defs>
			<filter id="blurlayer" width="110%" height="110%">
				<feGaussianBlur stdDeviation="4" result="blur"></feGaussianBlur>
			</filter>
			<pattern id="bgday" height="100%" width="100%" patternContentUnits="objectBoundingBox">
				<image width="1" height="1" preserveAspectRatio="none" xlink:href="bg_day.png"></image>
			</pattern>
			<pattern id="bgnight" height="100%" width="100%" patternContentUnits="objectBoundingBox">
				<image width="1" height="1" preserveAspectRatio="none" xlink:href="bg_night.png"></image>
			</pattern>
		</defs>

		<rect id="background" width="100%" height="100%"></rect>
		<g id="lines" transform="translate(43 154)">
			<circle class="st2" cx="257" cy="220" r="220"></circle>
			<line class="st2" x1="15" y1="140" x2="500" y2="140"></line>
		</g>
		<g  transform="translate(230, 275) scale(0.7)">
			<text id="dom_time" x="40" y="30" style="pointer-events: none;font: bold 30px sans-serif;stroke: #c6c7c8; stroke-width: 1;"></text>
		</g>
		<g class="st2">
			<path id="orbit" d="M505.74,294.59A220.56,220.56,0,0,0,100,282q-2.76,6-5.15,12.1" style="fill: none; stroke: red;"></path>

			<g id="moon" transform="translate(-1000 ,-1000)">
				<g  class="st4" transform="translate(-35 -35) scale(0.5)">
					<path d="M496.27,441.75c-6.1,15.89-6.36,30.77-1.74,45.64,4.76,15.34,13.79,27.25,27.15,36.65,13.07,9.2,27.28,12.76,42.67,12.39s28.79-7.17,41.67-16.83c-6.92,28.66-35.77,50.65-65,50.72-39.18.1-61.78-20.42-71.08-49.66C458.1,483.56,477,454.16,496.27,441.75Z" transform="translate(-465.74 -440.51)"></path>
				</g>
			</g>
			<g id="sun" transform="translate(-1000 ,-1000)">
				<g class="st2" transform="translate(-60 -60) scale(0.5)">
					<path class="st4" d="M511.81,579A66.53,66.53,0,0,1,445,512c0-37.5,29.82-67.1,67.43-66.94a67,67,0,0,1-.63,134Z" transform="translate(-395.23 -395.23)"></path>
					<path d="M428.85,429.31l27.51,27.83,1.42-1.4L430.1,428.08Z" transform="translate(-395.23 -395.23)"></path>
					<path d="M594.72,428.94l-27.55,27.68,1.29,1.31,27.61-27.68Z" transform="translate(-395.23 -395.23)"></path>
					<path d="M456.7,566.89l-27.57,27.67c.44.45.89.9,1.33,1.36l27.63-27.66Z" transform="translate(-395.23 -395.23)"></path>
					<path d="M567,567.28,594.6,594.9l1.27-1.25-27.64-27.71C567.81,566.39,567.4,566.84,567,567.28Z" transform="translate(-395.23 -395.23)"></path>
					<path d="M433.76,512.54H395.24v-1h38.52Z" transform="translate(-395.23 -395.23)"></path>
					<path d="M628.76,512.54H590.24c0-.33,0-.67,0-1h38.52C628.75,511.87,628.75,512.21,628.76,512.54Z" transform="translate(-395.23 -395.23)"></path>
				</g>
			</g>

		
		</g>

	</svg>
</body>
<script>
(function(root, factory) {
	'use strict';
	if (typeof define === 'function' && define.amd) {
		define(factory);
	} else if (typeof exports !== 'undefined') {
		module.exports = factory();
	} else {
		root.svg_controller = factory();
	}
	}(this, function() {
	var obj = {
		elements:{
			svg:document.getElementById('mysvg'),			
			path:document.getElementById('orbit'),
			sun:document.getElementById('sun'),
			moon:document.getElementById('moon'),
			dom_time:document.getElementById('dom_time'),
			bg:document.getElementById('my_bg'),
		},		
		point_density:0.3,
		start_time:0,
		total_time:24,
		current_time:0,
		sun_rise:7,
		sun_set:19,
		sun_cursor:0,
		moon_cursor:0,
		sun_position:0,
		moon_position:0,
		points:[],		
		get_time_proc:function(){
			if(!obj.startTime){ 
				obj.startTime = new Date();
				obj.startTime.setSeconds(obj.startTime.getSeconds()-obj.start_time);
				obj.startTime = new Date(obj.startTime);
			}
			endTime = new Date();
			obj.current_time = endTime - obj.startTime; 
			obj.current_time /= 1000;
			if (obj.current_time > obj.total_time){
				obj.current_time = 0;
				obj.startTime = new Date();
			}			
			return obj.current_time *100 /obj.total_time			
		},
		init_points:function(){
			obj.points = []			
			for (var i = Math.floor(obj.elements.path.getTotalLength());i>=0;i-=obj.point_density){				
				var pt = obj.elements.path.getPointAtLength(i);								
				obj.points.push(pt);
			}
			return obj;
		},
		move_el:function(el,point){
			var my_point = {
				x:point.x,
				y:point.y
			};					
			var transformAttr = ' translate(' + my_point.x + ',' + my_point.y + ')';			
			obj.elements[el].setAttribute('transform', transformAttr);
			return obj;
		},		
		set_sun:function(){								
			obj.get_time_proc();
			if(obj.current_time >= obj.sun_rise && obj.current_time <= obj.sun_set){
				var sun_length = obj.sun_set - obj.sun_rise
				var sun_pos  = obj.current_time - obj.sun_rise				
				obj.sun_position = sun_pos * 100/sun_length
			}
			else{				
				obj.sun_position = -1;
			}
			
			while (obj.sun_position>100) obj.sun_position -=100;
			return obj;
		},
		set_moon:function(){						
			obj.get_time_proc();
			if(obj.current_time >= obj.sun_rise && obj.current_time <= obj.sun_set){
				obj.moon_position = -1;
			}
			else{

				var moon_length = obj.sun_rise + obj.total_time - obj.sun_set
				var sun_pos  = obj.current_time - obj.sun_set
				console.log(moon_length+'/'+sun_pos)
				obj.moon_position = sun_pos * 100/moon_length

									
			}
			while (obj.moon_position>100) obj.moon_position -=100;
			return obj;
		},
		set_dom_time:function(){			
			var display_time = Math.round(obj.get_time_proc() * 86400 / 100);
			obj.elements.dom_time.textContent = new Date(display_time * 1000).toISOString().substr(11, 8);
			return obj;
		},
		set_background:function(){
			return false;			
			return this;
		},
		render:function(force){
			force =(force)?true:false;
			obj.set_sun().set_moon().set_dom_time().set_background();
			var sun_cursor =(obj.sun_position > 0)?Math.floor(obj.sun_position * (obj.points.length-1) /100):-1;
			var moon_cursor =(obj.moon_position > 0)? Math.floor(obj.moon_position * (obj.points.length-1) /100):-1;
			if (obj.sun_cursor != sun_cursor){				
				if(obj.sun_cursor >-1 &&  Math.abs(obj.sun_cursor - sun_cursor) > 4) force = true;	
				
				if (!force){
					obj.sun_cursor+=1;
					if (obj.sun_cursor >= obj.points.length) obj.sun_cursor = 0;					
				}else{
					obj.sun_cursor = sun_cursor
				}	
				if (obj.sun_cursor >= 0)	obj.move_el("sun",obj.points[obj.sun_cursor]);
				else obj.move_el("sun",{x:-1000,y:-1000});
			}			
			if (obj.moon_cursor != moon_cursor){
				if(obj.moon_cursor >-1 && Math.abs(obj.moon_cursor - moon_cursor) > 4) force = true;				
				if (!force){
					obj.moon_cursor+=1;
					if (obj.moon_cursor >= obj.points.length) obj.moon_cursor = 0;					
				}else{
					obj.moon_cursor = moon_cursor
				}				
				if (obj.moon_cursor >= 0) obj.move_el("moon",obj.points[obj.moon_cursor]);
				else obj.move_el("moon",{x:-1000,y:-1000});
			}	
			return obj;			
		},				
		init(start_time,total_time,sun_rise,sun_set){	
			obj.move_el("moon",{x:-1000,y:-1000}).move_el("sun",{x:-1000,y:-1000});		
			if (obj.timer) clearInterval(obj.timer);
			if (start_time || start_time ===0){
				if (obj.startTime) delete obj.startTime;
				obj.start_time = start_time;
			}
			if (total_time){				
				obj.total_time = total_time;
			}
			if (sun_rise || sun_rise ===0){
				obj.sun_rise = sun_rise
			}else if (!obj.sun_rise)  obj.sun_rise = 0;

			if (sun_set){
				obj.sun_set = sun_set
			} else if (!obj.sun_set) obj.sun_set = obj.total_time/2
			
			obj.get_time_proc();			
			obj.init_points().render(1);
			obj.timer = setInterval(function(){
				obj.render();
			},1);
			return obj;			
		}
	};
	return obj.init();	
}));

function live_time(){
	var dt = new Date();
	var secs = dt.getSeconds() + (60 * (dt.getMinutes() + (60 * dt.getHours())));
	svg_controller.init(secs,86400)
}

function sand_box_time(){
	var start_time = document.getElementById('start_time').value;	
	var total_time = document.getElementById('total_time').value;
	var sun_rise = document.getElementById('sun_rise').value;
	var sun_set = document.getElementById('sun_set').value;	
	svg_controller.init(start_time,total_time,sun_rise,sun_set)
}
document.getElementById('start_time').value = svg_controller.start_time;
document.getElementById('total_time').value = svg_controller.total_time;
document.getElementById('sun_rise').value = svg_controller.sun_rise;
document.getElementById('sun_set').value = svg_controller.sun_set;

</script>
</html>
